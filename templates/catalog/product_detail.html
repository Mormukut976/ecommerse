{% extends 'base.html' %}

{% block title %}{{ product.name }} - Shope in home{% endblock %}

{% block content %}
  <div class="product-detail">
    <div class="product-detail-image card">
      {% if gallery_images %}
        <div class="product-gallery" id="productGallery">
          <div class="product-gallery-thumbs">
            {% for img in gallery_images %}
              <button type="button" class="product-thumb{% if forloop.first %} is-active{% endif %}" data-index="{{ forloop.counter0 }}" data-full="{{ img.url }}" aria-label="View image {{ forloop.counter }}">
                <img src="{{ img.url }}" alt="{{ product.name }}">
              </button>
            {% endfor %}
          </div>

          <div class="product-gallery-main">
            <button type="button" class="gallery-nav gallery-nav-prev" aria-label="Previous image"><span>‹</span></button>
            <button type="button" class="gallery-nav gallery-nav-next" aria-label="Next image"><span>›</span></button>
            <img id="productMainImage" class="product-main-image" src="{{ gallery_images.0.url }}" alt="{{ product.name }}" tabindex="0">
          </div>
        </div>

        <div class="lightbox" id="productLightbox" role="dialog" aria-modal="true" aria-label="Product images">
          <div class="lightbox-panel" role="document">
            <button type="button" class="lightbox-close" id="lightboxClose" aria-label="Close"><span>×</span></button>
            <div class="lightbox-body">
              <div class="product-gallery" id="productLightboxGallery">
                <div class="product-gallery-thumbs">
                  {% for img in gallery_images %}
                    <button type="button" class="product-thumb{% if forloop.first %} is-active{% endif %}" data-index="{{ forloop.counter0 }}" data-full="{{ img.url }}" aria-label="View image {{ forloop.counter }}">
                      <img src="{{ img.url }}" alt="{{ product.name }}">
                    </button>
                  {% endfor %}
                </div>

                <div class="product-gallery-main">
                  <button type="button" class="gallery-nav gallery-nav-prev" aria-label="Previous image"><span>‹</span></button>
                  <button type="button" class="gallery-nav gallery-nav-next" aria-label="Next image"><span>›</span></button>
                  <img id="lightboxMainImage" src="{{ gallery_images.0.url }}" alt="{{ product.name }}">
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          (function () {
            var gallery = document.getElementById('productGallery');
            var main = document.getElementById('productMainImage');
            if (!gallery || !main) return;

            var lightbox = document.getElementById('productLightbox');
            var lightboxGallery = document.getElementById('productLightboxGallery');
            var lightboxMain = document.getElementById('lightboxMainImage');
            var lightboxClose = document.getElementById('lightboxClose');

            var pageThumbs = Array.prototype.slice.call(gallery.querySelectorAll('.product-thumb'));
            if (!pageThumbs.length) return;

            var urls = pageThumbs
              .map(function (btn) {
                return btn.getAttribute('data-full');
              })
              .filter(Boolean);

            var index = 0;

            function setActive(container, idx) {
              if (!container) return;
              var thumbs = container.querySelectorAll('.product-thumb');
              if (!thumbs || !thumbs.length) return;

              thumbs.forEach(function (btn) {
                var bi = parseInt(btn.getAttribute('data-index') || '0', 10);
                if (bi === idx) {
                  btn.classList.add('is-active');
                } else {
                  btn.classList.remove('is-active');
                }
              });
            }

            function setIndex(next) {
              if (!urls.length) return;
              if (next < 0) next = urls.length - 1;
              if (next >= urls.length) next = 0;
              index = next;

              var url = urls[index];
              if (url) main.src = url;
              if (lightbox && lightboxMain && url) lightboxMain.src = url;

              setActive(gallery, index);
              setActive(lightboxGallery, index);
            }

            function bindThumbs(container) {
              if (!container) return;
              var thumbs = container.querySelectorAll('.product-thumb');
              if (!thumbs || !thumbs.length) return;

              thumbs.forEach(function (btn) {
                btn.addEventListener('click', function () {
                  var idx = parseInt(btn.getAttribute('data-index') || '0', 10);
                  setIndex(idx);
                });
              });
            }

            function bindNav(container) {
              if (!container) return;
              var prev = container.querySelector('.gallery-nav-prev');
              var next = container.querySelector('.gallery-nav-next');

              if (prev) prev.addEventListener('click', function () { setIndex(index - 1); });
              if (next) next.addEventListener('click', function () { setIndex(index + 1); });

              if (urls.length <= 1) {
                if (prev) prev.style.display = 'none';
                if (next) next.style.display = 'none';
              }
            }

            function openLightbox() {
              if (!lightbox) return;
              lightbox.classList.add('is-open');
              document.body.classList.add('no-scroll');
              setIndex(index);
              if (lightboxClose) lightboxClose.focus();
            }

            function closeLightbox() {
              if (!lightbox) return;
              lightbox.classList.remove('is-open');
              document.body.classList.remove('no-scroll');
              main.focus();
            }

            bindThumbs(gallery);
            bindNav(gallery);
            bindThumbs(lightboxGallery);
            bindNav(lightboxGallery);

            main.addEventListener('click', openLightbox);
            main.addEventListener('keydown', function (e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openLightbox();
              }
            });

            if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
            if (lightbox) {
              lightbox.addEventListener('click', function (e) {
                if (e.target === lightbox) closeLightbox();
              });
            }

            document.addEventListener('keydown', function (e) {
              if (!lightbox || !lightbox.classList.contains('is-open')) return;
              if (e.key === 'Escape') closeLightbox();
              if (e.key === 'ArrowLeft') setIndex(index - 1);
              if (e.key === 'ArrowRight') setIndex(index + 1);
            });

            setIndex(0);
          })();
        </script>
      {% else %}
        <div class="image-placeholder large">No image</div>
      {% endif %}
    </div>

    <div class="product-detail-info">
      <h1 class="page-title">{{ product.name }}</h1>

      <div class="price-row">
        <div class="price">₹{{ product.selling_price }}</div>
        {% if product.original_price %}
          <div class="mrp">₹{{ product.original_price }}</div>
        {% endif %}
      </div>

      {% if product.description %}
        <p class="muted">{{ product.description }}</p>
      {% endif %}

      <div class="card form-card">
        <form method="post" action="{% url 'cart:add' product.id %}">
          {% csrf_token %}
          {% if sizes %}
            <label>Size</label>
            <select name="size_id">
              {% for s in sizes %}
                <option value="{{ s.id }}">{{ s.label }}</option>
              {% endfor %}
            </select>
          {% endif %}
          <label>Quantity</label>
          <input type="number" name="quantity" value="1" min="1">
          <button type="submit" class="btn mt">Add to Cart</button>
        </form>
      </div>

      <a class="link" href="{% url 'cart:detail' %}">Go to Cart</a>
    </div>
  </div>

  <div class="mt">
    <h2 class="section-title">Customer Reviews</h2>

    {% if reviews %}
      {% for r in reviews %}
        <div class="card mt">
          <div class="summary-row">
            <span><strong>{% if r.user %}{{ r.user.username }}{% elif r.name %}{{ r.name }}{% else %}Customer{% endif %}</strong></span>
            <span>{{ r.rating }}/5</span>
          </div>
          {% if r.comment %}
            <div class="muted">{{ r.comment|linebreaksbr }}</div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="card muted">No reviews yet.</div>
    {% endif %}

    <div class="mt">
      <h2 class="section-title">Write a Review</h2>
      <div class="card form-card">
        <form method="post" action="{% url 'catalog:product_review_create' product.slug %}">
          {% csrf_token %}
          {{ review_form.as_p }}
          <button type="submit" class="btn mt">Submit Review</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
